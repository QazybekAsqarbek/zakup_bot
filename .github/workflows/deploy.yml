name: Deploy to Yandex Cloud

on:
  push:
    branches:
      - main

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: zakup-bot

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run linter
        run: |
          pip install ruff
          ruff check . || true

      - name: Run basic syntax check
        run: |
          python -m py_compile src/**/*.py || true

  build-and-push:
    name: Build and Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to Yandex Container Registry
        uses: yc-actions/yc-cr-login@v3
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}"

          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ (Dockerfile –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ deploy/)
          docker build -f deploy/Dockerfile -t ${IMAGE_TAG}:latest -t ${IMAGE_TAG}:${{ github.sha }} .

          # –ü—É—à–∏–º –æ–±–∞ —Ç–µ–≥–∞
          docker push ${IMAGE_TAG}:latest
          docker push ${IMAGE_TAG}:${{ github.sha }}

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.prod.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy/docker-compose.prod.yml"
          target: "~/zakup-bot/"

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          MONGO_URL: ${{ secrets.MONGO_URL || 'mongodb://mongo:27017' }}
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
          NEW_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
          BACKUP_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:stable
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: TELEGRAM_TOKEN,ANTHROPIC_API_KEY,DEEPSEEK_API_KEY,MONGO_URL,YC_REGISTRY_ID,NEW_IMAGE,BACKUP_IMAGE
          script: |
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

            echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."

            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            export DEPLOY_DIR="$HOME/zakup-bot"
            mkdir -p "$DEPLOY_DIR/data" "$DEPLOY_DIR/logs"
            echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–µ–ø–ª–æ—è: $DEPLOY_DIR"

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ä–∞–±–æ—Ç–∞—é—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            CURRENT_IMAGE=""
            if docker ps --filter name=smart_procure_bot --format "{{.Image}}" | grep -q .; then
              CURRENT_IMAGE=$(docker ps --filter name=smart_procure_bot --format "{{.Image}}")
              echo "üì∏ –¢–µ–∫—É—â–∏–π –æ–±—Ä–∞–∑: $CURRENT_IMAGE"

              # –¢–µ–≥–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π –æ–±—Ä–∞–∑ –∫–∞–∫ stable (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è)
              docker tag "$CURRENT_IMAGE" "$BACKUP_IMAGE" || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å backup —Ç–µ–≥"
            else
              echo "‚ö†Ô∏è  –¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi

            # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "‚¨áÔ∏è  –°–∫–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑..."
            docker pull "$NEW_IMAGE"

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            
            # –ü–æ–ª—É—á–∞–µ–º ID –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∏–º–µ–Ω–µ–º smart_procure_bot (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
            CONTAINER_IDS=$(docker ps -a --filter name=smart_procure_bot --format "{{.ID}}" || true)
            
            if [ -n "$CONTAINER_IDS" ]; then
              echo "üóëÔ∏è  –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: $CONTAINER_IDS"
              for CONTAINER_ID in $CONTAINER_IDS; do
                echo "  –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–ª—è $CONTAINER_ID..."
                docker update --restart=no "$CONTAINER_ID" 2>/dev/null || true
                
                # –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                CONTAINER_PID=$(docker inspect "$CONTAINER_ID" --format '{{.State.Pid}}' 2>/dev/null || echo "")
                
                if [ -n "$CONTAINER_PID" ] && [ "$CONTAINER_PID" != "0" ]; then
                  echo "  –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $CONTAINER_ID (PID: $CONTAINER_PID)..."
                  sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
                  sleep 1
                else
                  echo "  –ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $CONTAINER_ID –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
                fi
                
                echo "  –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_ID..."
                docker rm -f "$CONTAINER_ID" 2>/dev/null || true
              done
              sleep 2
            fi
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            if docker ps -a --filter name=smart_procure_bot --format "{{.Names}}" | grep -q smart_procure_bot; then
              echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–∏–º–µ–Ω—è–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –º–µ—Ä—ã..."
              
              # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - —É–±–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å
              REMAINING_IDS=$(docker ps -a --filter name=smart_procure_bot --format "{{.ID}}")
              for CONTAINER_ID in $REMAINING_IDS; do
                CONTAINER_PID=$(docker inspect "$CONTAINER_ID" --format '{{.State.Pid}}' 2>/dev/null || echo "")
                if [ -n "$CONTAINER_PID" ] && [ "$CONTAINER_PID" != "0" ]; then
                  echo "  –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ —É–±–∏–≤–∞–µ–º PID: $CONTAINER_PID..."
                  sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
                fi
                sleep 1
                docker rm -f "$CONTAINER_ID" 2>/dev/null || true
              done
              sleep 2
              
              # –§–∏–Ω–∞–ª—å–Ω–∞—è-—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
              if docker ps -a --filter name=smart_procure_bot --format "{{.Names}}" | grep -q smart_procure_bot; then
                echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫!"
                docker ps -a --filter name=smart_procure_bot
                exit 1
              fi
            fi
            
            echo "‚úÖ –í—Å–µ —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã"

            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ docker-compose
            start_container() {
              echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ docker-compose..."
              
              # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±–∏—Ç
              OLD_CONTAINERS=$(docker ps -a --filter name=smart_procure_bot --format "{{.ID}}" || true)
              if [ -n "$OLD_CONTAINERS" ]; then
                echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –æ—Å—Ç–∞—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, —É–¥–∞–ª—è–µ–º..."
                for CID in $OLD_CONTAINERS; do
                  # –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
                  OLD_PID=$(docker inspect "$CID" --format '{{.State.Pid}}' 2>/dev/null || echo "")
                  if [ -n "$OLD_PID" ] && [ "$OLD_PID" != "0" ]; then
                    echo "  –£–±–∏–≤–∞–µ–º PID: $OLD_PID"
                    sudo kill -9 "$OLD_PID" 2>/dev/null || true
                  fi
                  sleep 1
                  # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                  docker rm -f "$CID" 2>/dev/null || true
                done
                sleep 2
              fi
              
              # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
              echo "üìù –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
              {
                echo "TELEGRAM_TOKEN=$TELEGRAM_TOKEN"
                echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY"
                echo "DEEPSEEK_API_KEY=$DEEPSEEK_API_KEY"
                echo "MONGO_URL=$MONGO_URL"
              } > "$DEPLOY_DIR/.env"
              
              # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ docker-compose
              cd "$DEPLOY_DIR"
              sudo docker-compose -f docker-compose.prod.yml up -d
            }

            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–∑: $NEW_IMAGE"
            if start_container; then
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
              exit 1
            fi

            # –ñ–¥–µ–º –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
            echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–¥–æ 60 —Å–µ–∫—É–Ω–¥)..."
            STARTUP_TIMEOUT=60
            STARTUP_INTERVAL=5
            ELAPSED=0
            
            while [ $ELAPSED -lt $STARTUP_TIMEOUT ]; do
              if docker ps --filter name=smart_procure_bot --filter status=running | grep -q smart_procure_bot; then
                echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
                break
              else
                echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (–ø—Ä–æ—à–ª–æ ${ELAPSED}—Å)..."
                sleep $STARTUP_INTERVAL
                ELAPSED=$((ELAPSED + STARTUP_INTERVAL))
              fi
            done
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            CONTAINER_RUNNING=$(docker ps --filter name=smart_procure_bot --filter status=running | grep -q smart_procure_bot && echo "yes" || echo "no")
            
            if [ "$CONTAINER_RUNNING" = "yes" ]; then
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"

              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
              LOGS=$(docker logs smart_procure_bot 2>&1 | tail -100)

              if echo "$LOGS" | grep -iE "CRITICAL|ERROR.*Failed to|Exception.*startup|‚ùå"; then
                echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö!"
                
                # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
                if [ -n "$CURRENT_IMAGE" ]; then
                  echo "üîô –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏: $CURRENT_IMAGE"
                  
                  # –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ —É–±–∏–≤–∞–µ–º –µ–≥–æ
                  CONTAINER_PID=$(docker inspect smart_procure_bot --format '{{.State.Pid}}' 2>/dev/null || echo "")
                  if [ -n "$CONTAINER_PID" ] && [ "$CONTAINER_PID" != "0" ]; then
                    sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
                    sleep 1
                  fi
                  
                  docker stop smart_procure_bot 2>/dev/null || true
                  docker rm -f smart_procure_bot 2>/dev/null || true
                  
                  # –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º backup –æ–±—Ä–∞–∑ –∫–∞–∫ latest –¥–ª—è docker-compose
                  echo "üì¶ –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º $BACKUP_IMAGE -> $NEW_IMAGE"
                  docker tag "$BACKUP_IMAGE" "$NEW_IMAGE" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Ç–µ–≥–∏—Ä–æ–≤–∞—Ç—å"
                  
                  start_container
                  sleep 10
                  echo "üîÑ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
                  docker logs smart_procure_bot --tail=30
                  exit 1
                else
                  echo "‚ö†Ô∏è  –ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞!"
                  docker logs smart_procure_bot --tail=50
                  exit 1
                fi
              else
                echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!"
                docker logs smart_procure_bot --tail=30
                echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
                docker ps --filter name=smart_procure_bot
              fi
            else
              echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              
              # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
              if [ -n "$CURRENT_IMAGE" ]; then
                echo "üîô –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏: $CURRENT_IMAGE"
                
                # –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ —É–±–∏–≤–∞–µ–º –µ–≥–æ
                CONTAINER_PID=$(docker inspect smart_procure_bot --format '{{.State.Pid}}' 2>/dev/null || echo "")
                if [ -n "$CONTAINER_PID" ] && [ "$CONTAINER_PID" != "0" ]; then
                  sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
                  sleep 1
                fi
                
                docker stop smart_procure_bot 2>/dev/null || true
                docker rm -f smart_procure_bot 2>/dev/null || true
                
                # –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º backup –æ–±—Ä–∞–∑ –∫–∞–∫ latest –¥–ª—è docker-compose
                echo "üì¶ –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º $BACKUP_IMAGE -> $NEW_IMAGE"
                docker tag "$BACKUP_IMAGE" "$NEW_IMAGE" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Ç–µ–≥–∏—Ä–æ–≤–∞—Ç—å"
                
                start_container
                sleep 10
                echo "üîÑ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω"
                docker logs smart_procure_bot --tail=30
              else
                echo "‚ö†Ô∏è  –ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞!"
                docker logs smart_procure_bot --tail=50
              fi
              exit 1
            fi

      - name: Final verification
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."

            if docker ps --filter name=smart_procure_bot --filter status=running | grep -q smart_procure_bot; then
              echo "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
              echo ""
              echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:"
              docker ps --filter name=smart_procure_bot --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              docker logs smart_procure_bot --tail=20
            else
              echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              docker logs smart_procure_bot --tail=50 2>&1 || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
              exit 1
            fi

  notify:
    name: Send Telegram Notification
    needs: [test, build-and-push, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Send notification
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –∫–∞–∂–¥–æ–≥–æ job
          TEST_STATUS="${{ needs.test.result }}"
          BUILD_STATUS="${{ needs.build-and-push.result }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"
          
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
          format_status() {
            local status=$1
            local name=$2
            case "$status" in
              "success")
                echo "‚úÖ <b>${name}:</b> —É—Å–ø–µ—à–Ω–æ"
                ;;
              "failure")
                echo "‚ùå <b>${name}:</b> –æ—à–∏–±–∫–∞"
                ;;
              "cancelled")
                echo "‚ö†Ô∏è <b>${name}:</b> –æ—Ç–º–µ–Ω–µ–Ω"
                ;;
              "skipped")
                echo "‚è≠Ô∏è <b>${name}:</b> –ø—Ä–æ–ø—É—â–µ–Ω"
                ;;
              *)
                echo "‚ùì <b>${name}:</b> ${status:-–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}"
                ;;
            esac
          }
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ jobs —É—Å–ø–µ—à–Ω—ã (—É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ skipped/null –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—Ö–æ–º)
          ALL_SUCCESS=true
          if [ "$TEST_STATUS" != "success" ] || [ -z "$TEST_STATUS" ]; then
            ALL_SUCCESS=false
          fi
          if [ "$BUILD_STATUS" != "success" ] || [ -z "$BUILD_STATUS" ]; then
            ALL_SUCCESS=false
          fi
          if [ "$DEPLOY_STATUS" != "success" ] || [ -z "$DEPLOY_STATUS" ]; then
            ALL_SUCCESS=false
          fi
          
          if [ "$ALL_SUCCESS" = "true" ]; then
            EMOJI="‚úÖ"
            TITLE="<b>–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!</b>"
            STATUS_TEXT="–í—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
          else
            EMOJI="‚ùå"
            TITLE="<b>–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!</b>"
            STATUS_TEXT=""
            
            STATUS_TEXT="${STATUS_TEXT}$(format_status "${TEST_STATUS:-skipped}" "–¢–µ—Å—Ç—ã/–õ–∏–Ω—Ç–µ—Ä")%0A"
            STATUS_TEXT="${STATUS_TEXT}$(format_status "${BUILD_STATUS:-skipped}" "–°–±–æ—Ä–∫–∞")%0A"
            STATUS_TEXT="${STATUS_TEXT}$(format_status "${DEPLOY_STATUS:-skipped}" "–î–µ–ø–ª–æ–π")%0A"
          fi
          
          MESSAGE="${EMOJI} ${TITLE}%0A%0ACommit: <code>${COMMIT_SHA}</code>%0A${COMMIT_MSG}%0A%0A${STATUS_TEXT}%0A<a href='${WORKFLOW_URL}'>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Actions</a>"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.ADMIN_CHAT }}" \
            -d "parse_mode=HTML" \
            -d "text=${MESSAGE}"

