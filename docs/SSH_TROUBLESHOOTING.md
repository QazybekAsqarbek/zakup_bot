# üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å SSH –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –≤ CI/CD

## –û—à–∏–±–∫–∞: `ssh: unable to authenticate, attempted methods [none publickey]`

–≠—Ç–∞ –æ—à–∏–±–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ GitHub Actions –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH.

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –∫–ª—é—á–∞ –≤ GitHub Secrets

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª—é—á –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω.

**–†–µ—à–µ–Ω–∏–µ:**

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `SSH_PRIVATE_KEY` —Å–æ–¥–µ—Ä–∂–∏—Ç **–≤–µ—Å—å** –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á, –≤–∫–ª—é—á–∞—è:
   ```
   -----BEGIN OPENSSH PRIVATE KEY-----
   [—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–∞]
   -----END OPENSSH PRIVATE KEY-----
   ```
   
   –ò–õ–ò –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:
   ```
   -----BEGIN RSA PRIVATE KEY-----
   [—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–∞]
   -----END RSA PRIVATE KEY-----
   ```

2. **–í–∞–∂–Ω–æ:** –ü—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–ª—é—á–∞ –≤ GitHub Secrets:
   - –ö–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á **–ø–æ–ª–Ω–æ—Å—Ç—å—é**, –≤–∫–ª—é—á–∞—è –ø–µ—Ä–≤—É—é –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫–∏
   - –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –Ω–∞—á–∞–ª–µ –∏–ª–∏ –∫–æ–Ω—Ü–µ
   - –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –∫–ª—é—á–∞
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "Raw" —Ä–µ–∂–∏–º –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ –ª–æ–∫–∞–ª—å–Ω–æ:
   ```bash
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–ª—é—á –≤–∞–ª–∏–¥–Ω—ã–π
   ssh-keygen -l -f ~/.ssh/id_rsa
   
   # –ò–ª–∏ –¥–ª—è –∫–ª—é—á–∞ Yandex Cloud
   ssh-keygen -l -f ~/.ssh/yc-organization-id-*-<user>
   ```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `authorized_keys` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É:
   ```bash
   ssh <username>@<server_ip>
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞:
   ```bash
   cat ~/.ssh/authorized_keys
   ```

3. –ï—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç, –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ:
   ```bash
   # –ù–∞ –≤–∞—à–µ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –ø–æ–ª—É—á–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
   cat ~/.ssh/id_rsa.pub
   
   # –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—ã–≤–æ–¥ –∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
   echo "–≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á" >> ~/.ssh/authorized_keys
   chmod 600 ~/.ssh/authorized_keys
   chmod 700 ~/.ssh
   ```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `YC_INSTANCE_USER`.

**–†–µ—à–µ–Ω–∏–µ:**

1. –î–ª—è Yandex Cloud VM –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—ã—á–Ω–æ:
   - `ubuntu` (–¥–ª—è Ubuntu –æ–±—Ä–∞–∑–æ–≤)
   - `yc-user` (–¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤)
   - –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö VM

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   ```bash
   # –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ VM
   yc compute instance get <instance-name> --format yaml | grep -A 5 metadata
   ```

3. –ò–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ:
   ```bash
   ssh <username>@<server_ip>
   ```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π IP –∞–¥—Ä–µ—Å –≤ `YC_INSTANCE_IP`.

**–†–µ—à–µ–Ω–∏–µ:**

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ **–ø—É–±–ª–∏—á–Ω—ã–π** IP –∞–¥—Ä–µ—Å:
   ```bash
   yc compute instance get <instance-name> --format json | \
     jq -r '.network_interfaces[0].primary_v4_address.one_to_one_nat.address'
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ IP –∞–¥—Ä–µ—Å –¥–æ—Å—Ç—É–ø–µ–Ω:
   ```bash
   ping <server_ip>
   ```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** SSH —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–∞—Ä–æ–ª—å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é.

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
   ```bash
   sudo cat /etc/ssh/sshd_config | grep -E "PubkeyAuthentication|PasswordAuthentication|AuthorizedKeysFile"
   ```

2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∫–ª—é—á–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∫–ª—é—á–∞–º:
   ```
   PubkeyAuthentication yes
   AuthorizedKeysFile .ssh/authorized_keys
   ```

3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ SSH —Å–µ—Ä–≤–µ—Ä:
   ```bash
   sudo systemctl restart sshd
   ```

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º SSH.

**–†–µ—à–µ–Ω–∏–µ:**

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
chown -R $USER:$USER ~/.ssh
```

## ‚úÖ –ü–æ—à–∞–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```bash
# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º
ssh -i ~/.ssh/id_rsa <username>@<server_ip>
```

–ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±–ª–µ–º–∞ –≤ GitHub Secrets.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–∞ –≤ GitHub

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**
2. –û—Ç–∫—Ä–æ–π—Ç–µ `SSH_PRIVATE_KEY`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–ª—é—á –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `-----BEGIN` –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è `-----END`
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ SSH –∫–ª—é—á–∞ (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç)

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –ø–∞—Ä—É –∫–ª—é—á–µ–π
ssh-keygen -t rsa -b 4096 -C "github-actions" -f ~/.ssh/github_actions_key

# –î–æ–±–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh-copy-id -i ~/.ssh/github_actions_key.pub <username>@<server_ip>

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
cat ~/.ssh/github_actions_key.pub | ssh <username>@<server_ip> "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"

# –û–±–Ω–æ–≤–∏—Ç–µ SSH_PRIVATE_KEY –≤ GitHub Secrets —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:
cat ~/.ssh/github_actions_key
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ workflow

–Ø –æ–±–Ω–æ–≤–∏–ª workflow —Ñ–∞–π–ª:
1. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤–µ—Ä—Å–∏–∏ actions –¥–æ `@master` (–±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ)
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —à–∞–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ñ–∞–π–ª–∞
3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `debug: true` –∏ `timeout: 60s` –¥–ª—è –ª—É—á—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## üìù –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] `SSH_PRIVATE_KEY` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
- [ ] `YC_INSTANCE_USER` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] `YC_INSTANCE_IP` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å
- [ ] –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ `~/.ssh/authorized_keys` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: `~/.ssh` = 700, `authorized_keys` = 600
- [ ] SSH —Å–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –ø—Ä–∏–µ–º –∫–ª—é—á–µ–π (`PubkeyAuthentication yes`)
- [ ] –õ–æ–∫–∞–ª—å–Ω–æ–µ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üÜò –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç

1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞):
   ```yaml
   password: ${{ secrets.SSH_PASSWORD }}
   ```

2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π action –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤:
   ```yaml
   - name: Copy files
     uses: burnett01/rsync-deployments@6.0.0
     with:
       switches: -avzr --delete
       path: deploy/docker-compose.prod.yml
       remote_path: ~/zakup-bot/
       remote_host: ${{ secrets.YC_INSTANCE_IP }}
       remote_user: ${{ secrets.YC_INSTANCE_USER }}
       remote_key: ${{ secrets.SSH_PRIVATE_KEY }}
   ```

3. –ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ SSH –∫–æ–º–∞–Ω–¥—É:
   ```yaml
   - name: Copy docker-compose via SSH
     uses: appleboy/ssh-action@master
     with:
       host: ${{ secrets.YC_INSTANCE_IP }}
       username: ${{ secrets.YC_INSTANCE_USER }}
       key: ${{ secrets.SSH_PRIVATE_KEY }}
       script: |
         cat > ~/zakup-bot/docker-compose.prod.yml << 'EOF'
         [—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞]
         EOF
       ```

